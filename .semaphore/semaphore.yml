version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: 'Block #1'
    dependencies: []
    task:
      prologue:
        commands:
          # Get the latest version of our source code from GitHub:
          - checkout

      jobs:
        - name: 'Job #1'
          commands:
          - export FLAKEHUB_PUSH_BINARY_URL="https://install.determinate.systems/flakehub-push/branch/main/X64-Linux?ci=semaphore"
          - export MAGIC_NIX_CACHE_BINARY_URL="https://install.determinate.systems/magic-nix-cache/branch/main/X64-Linux?ci=semaphore"

          # debug only:
          - export FLAKEHUB_API_ADDR="https://api.cluster-activate-exited.ngrok-free.app/"
          - export FLAKEHUB_FRONTEND_ADDR="https://web.cluster-activate-exited.ngrok-free.app/"
          - export FLAKEHUB_CACHE_ADDR="https://cache.cluster-activate-exited.ngrok-free.app/"
          # debug only:
          - export FLAKEHUB_PUSH_BINARY_URL="https://install.determinate.systems/flakehub-push/pr/222/X64-Linux?ci=semaphore"
          - export MAGIC_NIX_CACHE_BINARY_URL="https://install.determinate.systems/flakehub-push/pr/222/X64-Linux?ci=semaphore"

          # acquire `flakehub-push`:
          - curl -L "${FLAKEHUB_PUSH_BINARY_URL}" | sudo tee /usr/bin/flakehub-push &>/dev/null
          - sudo chmod +x /usr/bin/flakehub-push
          # acquire `magic-nix-cache`:
          - curl -L "${MAGIC_NIX_CACHE_BINARY_URL}" | sudo tee /usr/bin/magic-nix-cache &>/dev/null
          - sudo chmod +x /usr/bin/magic-nix-cache

          # install determinate nix
          - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --determinate --no-confirm --init systemd
          - . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh

          # login with `determinate-nixd login` (used by magic-nix-cache, substitutions)
          - echo "${SEMAPHORE_OIDC_TOKEN}" | determinate-nixd login token --token-file /dev/stdin

          # stage login credentials for flakehub-push
          - export FLAKEHUB_PUSH_OIDC_TOKEN="${SEMAPHORE_OIDC_TOKEN}"

          # debug only:
          - sudo systemctl set-environment FLAKEHUB_API_ADDR="${FLAKEHUB_API_ADDR}"
          - sudo systemctl set-environment FLAKEHUB_FRONTEND_ADDR="${FLAKEHUB_FRONTEND_ADDR}"
          - sudo systemctl set-environment FLAKEHUB_CACHE_ADDR="${FLAKEHUB_CACHE_ADDR}"
          - sudo systemctl daemon-reload
          - sudo systemctl restart nix-daemon

          # test publishing a rolling release
          # TODO: file ticket to see why --repository is really needed here.....? it's not for mnc? (right?)
          - export FLAKE_OWNER="$(echo "${SEMAPHORE_ORGANIZATION_URL}" | cut -d "." -f1 | cut -d '/' -f3)" # TODO: semaphore, this is just silly :|
          - export FLAKE_NAME="${SEMAPHORE_PROJECT_NAME}"
          - flakehub-push --repository '${FLAKE_OWNER}/${FLAKE_NAME}' --rolling --rolling-minor 1 --visibility private

version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: 'Block #1'
    dependencies: []
    task:
      prologue:
        commands:
          # Get the latest version of our source code from GitHub:
          - checkout

      jobs:
        - name: 'Job #1'
          commands:
          - export FLAKEHUB_PUSH_REPOSITORY="$(echo "${SEMAPHORE_ORGANIZATION_URL}" | cut -d "." -f1 | cut -d '/' -f3)/${SEMAPHORE_PROJECT_NAME}"
          - export FLAKEHUB_PUSH_BINARY_URL="https://install.determinate.systems/flakehub-push/branch/main/X64-Linux?ci=semaphore"
          - export MAGIC_NIX_CACHE_BINARY_URL="https://install.determinate.systems/magic-nix-cache/branch/main/X64-Linux?ci=semaphore"

          # debug only:
          - export FLAKEHUB_API_ADDR="https://api.cluster-activate-exited.ngrok-free.app/"
          - export FLAKEHUB_FRONTEND_ADDR="https://web.cluster-activate-exited.ngrok-free.app/"
          - export FLAKEHUB_CACHE_ADDR="https://cache.cluster-activate-exited.ngrok-free.app/"
          - export FLAKEHUB_PUSH_HOST="${FLAKEHUB_API_ADDR}"
          - export FLAKEHUB_PUSH_REPOSITORY="DeterminateSystems/test" # local debug, change for test in prod
          # debug only:
          - export FLAKEHUB_PUSH_BINARY_URL="https://install.determinate.systems/flakehub-push/pr/222/X64-Linux?ci=semaphore"
          - export MAGIC_NIX_CACHE_BINARY_URL="https://install.determinate.systems/flakehub-push/pr/222/X64-Linux?ci=semaphore"

          # acquire `flakehub-push`:
          - curl -L "${FLAKEHUB_PUSH_BINARY_URL}" | sudo tee /usr/bin/flakehub-push &>/dev/null
          - sudo chmod +x /usr/bin/flakehub-push
          # acquire `magic-nix-cache`:
          - curl -L "${MAGIC_NIX_CACHE_BINARY_URL}" | sudo tee /usr/bin/magic-nix-cache &>/dev/null
          - sudo chmod +x /usr/bin/magic-nix-cache

          # install determinate nix
          - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --determinate --no-confirm --init systemd
          - . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh

          # debug only:
          - sudo systemctl set-environment FLAKEHUB_API_ADDR="${FLAKEHUB_API_ADDR}"
          - sudo systemctl set-environment FLAKEHUB_FRONTEND_ADDR="${FLAKEHUB_FRONTEND_ADDR}"
          - sudo systemctl set-environment FLAKEHUB_CACHE_ADDR="${FLAKEHUB_CACHE_ADDR}"
          - sudo systemctl daemon-reload
          - sudo systemctl restart nix-daemon

          # login with `determinate-nixd login` (used by magic-nix-cache, substitutions)
          - echo "${SEMAPHORE_OIDC_TOKEN}" | determinate-nixd login token --token-file /dev/stdin

          # stage login credentials for flakehub-push
          - export FLAKEHUB_PUSH_OIDC_TOKEN="${SEMAPHORE_OIDC_TOKEN}"

          # test publishing a rolling release
          # TODO: file ticket to see why --repository / FLAKEHUB_PUSH_REPOSITORY is really needed here.....? it's not for mnc? (right?)
          # TODO: why did this let me rolling release and and then suddenly stop:
          - flakehub-push --rolling --rolling-minor 1 --visibility private

          # test magic-nix-cache
          - magic-nix-cache --use-flakehub || true
          - export DRV="$(nix eval .packages.x86_64-linux.default.drvPath)"
          - export OUT="$(nix eval .packages.x86_64-linux.default.outPath)"
          - nix build "${DRV}^*" --no-out-link
          - sleep 10 # wait on mnc, I guess
          - nix store delete "${OUT}"
          - nix build -j0 "${OUT}" --option narinfo-cache-negative-ttl 0
version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: 'Block #1'
    dependencies: []
    task:
      prologue:
        commands:
          # Get the latest version of our source code from GitHub:
          - checkout

      jobs:
        - name: 'Job #1'
          commands:
          - ls
          - exit 1
          - mkdir /home/semaphore/cache
          - export FLAKEHUB_PUSH_HOST="https://api.cluster-activate-exited.ngrok-free.app/"
          - export FLAKEHUB_WEB_ENDPOINT="https://web.cluster-activate-exited.ngrok-free.app"
          # - export FLAKEHUB_PUSH_BINARY_URL="https://install.determinate.systems/flakehub-push/branch/main/X64-Linux?ci=semaphore"
          - export FLAKEHUB_PUSH_BINARY_URL="https://install.determinate.systems/flakehub-push/pr/222/X64-Linux?ci=semaphore"
          - export NIX_INSTALLER_EXTRA_CONF="/home/semaphore/cache/flakehub-extra-conf"
          - export NIX_INSTALLER_NETRC="/home/semaphore/cache/nix-netrc"

          - echo "machine ${FLAKEHUB_WEB_ENDPOINT} login flakehub password ${SEMAPHORE_OIDC_TOKEN}" >> "${NIX_INSTALLER_NETRC}"
          - echo "machine ${FLAKEHUB_API_ENDPOINT} login flakehub password ${SEMAPHORE_OIDC_TOKEN}" >> "${NIX_INSTALLER_NETRC}"
          - echo "netrc-file = ${NIX_INSTALLER_NETRC}" > "${NIX_INSTALLER_EXTRA_CONF}"

          - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --determinate --no-confirm --init systemd
          - . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh

          - export FLAKEHUB_PUSH_OIDC_TOKEN="${SEMAPHORE_OIDC_TOKEN}"

          # temp, for demo only:
          - sudo mkdir -p /etc/systemd/system/nix-daemon.service.d
          - printf "\n[Service]\nExecStart=\nExecStart=@/usr/local/bin/determinate-nixd determinate-nixd --flakehub-api-addr \"${FLAKEHUB_PUSH_HOST}\" daemon" | sudo tee /etc/systemd/system/nix-daemon.service.d/override-flakehub-api-addr.conf
          - sudo systemctl daemon-reload
          - sudo systemctl restart nix-daemon || true

          # dnixd login (for m-n-c):
          - echo "${SEMAPHORE_OIDC_TOKEN}" > /tmp/semaphore-token
          # remove next line:
          - cat /tmp/semaphore-token | base64 -w0
          - RUST_LOG=debug determinate-nixd --flakehub-api-addr "${FLAKEHUB_PUSH_HOST}" login token --token-file "/tmp/semaphore-token"

          # acquire flakehub-push:
          - echo "${FLAKEHUB_PUSH_BINARY_URL}"
          - curl -L "${FLAKEHUB_PUSH_BINARY_URL}" -o /tmp/flakehub-push
          - chmod +x /tmp/flakehub-push
          - /tmp/flakehub-push --repository 'DeterminateSystems/test'

          # temp, for demo only:
          - sudo env PAGER=cat journalctl -u nix-daemon.service
